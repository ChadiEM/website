name: Publish Container Image to GCP Artifact Registry

on:
  push:
    branches: ["master"]

jobs:
  build-push-registry:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: "${{ secrets.PROJECT_ID }}"
      REPOSITORY: container-images
      IMAGE: website
      REGION: europe-west3-docker.pkg.dev

    steps:
      - uses: actions/checkout@v2
      - name: Check if Git tag exists
        id: tag
        run: echo "::set-output name=tag::$(git tag --points-at HEAD)"

      - name: Build Docker Image
        run: docker build -t $IMAGE .

      - id: auth
        uses: google-github-actions/auth@v0
        with:
          credentials_json: "${{ secrets.SERVICE_ACCOUNT_KEY }}"
      - uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker Client
        run: |-
          gcloud auth configure-docker $REGION --quiet

      - name: Push Docker Image to Artifact Registry (latest)
        run: |-
          docker tag $IMAGE $REGION/$PROJECT_ID/$REPOSITORY/$IMAGE:latest
          docker push $REGION/$PROJECT_ID/$REPOSITORY/$IMAGE:latest

      - name: Push Docker Image to Artifact Registry (tag)
        if: ${{ steps.tag.outputs.tag }}
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |-
          docker tag $IMAGE $REGION/$PROJECT_ID/$REPOSITORY/$IMAGE:$TAG
          docker push $REGION/$PROJECT_ID/$REPOSITORY/$IMAGE:$TAG
